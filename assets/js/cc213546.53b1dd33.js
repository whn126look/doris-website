"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["931145"],{645812:function(e,n,i){i.r(n),i.d(n,{metadata:()=>t,contentTitle:()=>a,default:()=>h,assets:()=>o,toc:()=>c,frontMatter:()=>s});var t=JSON.parse('{"id":"admin-manual/workload-management/sql-blocking","title":"Query Blocking","description":"\x3c!--","source":"@site/docs/admin-manual/workload-management/sql-blocking.md","sourceDirName":"admin-manual/workload-management","slug":"/admin-manual/workload-management/sql-blocking","permalink":"/docs/dev/admin-manual/workload-management/sql-blocking","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Query Blocking","language":"zh-CN"},"sidebar":"docs","previous":{"title":"Managing Compute Groups","permalink":"/docs/dev/admin-manual/workload-management/compute-group"},"next":{"title":"Kill Query","permalink":"/docs/dev/admin-manual/workload-management/kill-query"}}'),l=i("785893"),r=i("250065");let s={title:"Query Blocking",language:"zh-CN"},a=void 0,o={},c=[{value:"SQL Block Rule",id:"sql-block-rule",level:2},{value:"Usage Note",id:"usage-note",level:3},{value:"Global-level Blocking Rule",id:"global-level-blocking-rule",level:4},{value:"User-level Blocking Rule",id:"user-level-blocking-rule",level:4},{value:"Other Operations",id:"other-operations",level:4},{value:"Usage Scenarios",id:"usage-scenarios",level:3},{value:"Blocking Queries that Scan More Than a Specified Number of Rows",id:"blocking-queries-that-scan-more-than-a-specified-number-of-rows",level:4},{value:"Blocking Queries that Scan More Than a Specified Number of Partitions",id:"blocking-queries-that-scan-more-than-a-specified-number-of-partitions",level:4},{value:"Blocking Queries that Scan More Than a Specified Number of Tablets",id:"blocking-queries-that-scan-more-than-a-specified-number-of-tablets",level:4},{value:"Blocking Specific Query Patterns",id:"blocking-specific-query-patterns",level:4},{value:"FAQ",id:"faq",level:3},{value:"Q: Can regex-based blocking rules have adverse effects on the cluster?",id:"q-can-regex-based-blocking-rules-have-adverse-effects-on-the-cluster",level:4},{value:"Q: Can a blocking rule be temporarily disabled?",id:"q-can-a-blocking-rule-be-temporarily-disabled",level:4},{value:"Q: What regex syntax is used in blocking rules?",id:"q-what-regex-syntax-is-used-in-blocking-rules",level:4},{value:"Workload Group Policy",id:"workload-group-policy",level:2},{value:"NOTE",id:"note",level:3},{value:"Supported Workload Load",id:"supported-workload-load",level:3},{value:"Create Workload Policy",id:"create-workload-policy",level:3},{value:"Binding Workload Policy to Workload Group",id:"binding-workload-policy-to-workload-group",level:3},{value:"Test",id:"test",level:2},{value:"1 set session variables",id:"1-set-session-variables",level:3},{value:"2 big query fusing test",id:"2-big-query-fusing-test",level:3}];function d(e){let n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.a)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.p,{children:"Query Circuit Breaker is a protection mechanism designed to prevent long-running or resource-intensive queries from negatively impacting the system. When a query exceeds predefined resource or time limits, the circuit breaker automatically terminates the query to avoid adverse effects on system performance, resource utilization, and other queries. This mechanism ensures the stability of the cluster in a multi-user environment, preventing individual queries from depleting system resources, slowing down responses, or causing deadlocks, thereby enhancing overall availability and efficiency.\nIn Doris, there are two types of circuit breaker strategies:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Planning-time Circuit Breaker (SQL Block Rule): Used to prevent statements that match specific patterns from executing. Blocking rules apply to any SQL statements, including DDL and DML. Typically, blocking rules are configured by database administrators (DBAs) to enhance cluster stability. Examples include:\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Blocking a query that scans too many rows of data"}),"\n",(0,l.jsx)(n.li,{children:"Blocking a query that scans too many partitions"}),"\n",(0,l.jsx)(n.li,{children:"Blocking a statement that modifies global variables to prevent unintended cluster configuration changes"}),"\n",(0,l.jsx)(n.li,{children:"Blocking a query pattern that typically consumes significant resources"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"Runtime Circuit Breaker (Workload Policy): Monitors query execution time, data scanned, and memory consumed in real-time to implement rule-based query termination."}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"sql-block-rule",children:"SQL Block Rule"}),"\n",(0,l.jsx)(n.p,{children:"Based on the blocking pattern, SQL Block Rules can be classified into:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Row count blocking rules"}),"\n",(0,l.jsx)(n.li,{children:"Partition count blocking rules"}),"\n",(0,l.jsx)(n.li,{children:"Tablet count blocking rules"}),"\n",(0,l.jsx)(n.li,{children:"SQL regex match blocking rules"}),"\n",(0,l.jsx)(n.li,{children:"SQL hash value match blocking rules"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Blocking rules can also be classified by scope:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Global-level blocking rules"}),"\n",(0,l.jsx)(n.li,{children:"User-level blocking rules"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"usage-note",children:"Usage Note"}),"\n",(0,l.jsx)(n.h4,{id:"global-level-blocking-rule",children:"Global-level Blocking Rule"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'CREATE SQL_BLOCK_RULE rule_001\nPROPERTIES (\n  "sql"="select \\\\* from t",\n  "global" = "true",\n  "enable" = "true"\n)\n'})}),"\n",(0,l.jsxs)(n.p,{children:["This creates a global-level blocking rule named rule_001. It uses a regex to block any query that matches ",(0,l.jsx)(n.code,{children:"select \\\\* from t"}),".\nSince it's a global-level rule, any user attempting to execute a matching query will be blocked. For example:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"MySQL root@127.0.0.1:test> select * from t;\n(1105, 'errCode = 2, detailMessage = errCode = 2, detailMessage = sql match regex sql block rule: rule_001')\n"})}),"\n",(0,l.jsx)(n.h4,{id:"user-level-blocking-rule",children:"User-level Blocking Rule"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'CREATE SQL_BLOCK_RULE rule_001\nPROPERTIES (\n  "sql"="select * from t",\n  "global" = "false",\n  "enable" = "true"\n)\n'})}),"\n",(0,l.jsx)(n.p,{children:'Unlike global-level rules, user-level rules only apply to specified users. To create a user-level rule, set the "global" property to "false". Additionally, you need to set the sql_block_rules property for the user:'}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"set property for 'root' 'sql_block_rules' = 'rule_001';\n"})}),"\n",(0,l.jsx)(n.p,{children:"With this configuration, the rule_001 blocking rule will apply to the root user."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"MySQL root@127.0.0.1:test> set property for 'root' 'sql_block_rules' = '';\nQuery OK, 0 rows affected\nTime: 0.018s\nMySQL root@127.0.0.1:test> select * from t;\n+----+----+\n| id | c1 |\n+----+----+\n| 1  | 1  |\n+----+----+\n\n1 row in set\nTime: 0.027s\nMySQL root@127.0.0.1:test> set property for 'root' 'sql_block_rules' = 'rule_001';\nQuery OK, 0 rows affected\nTime: 0.008s\nMySQL root@127.0.0.1:test> select * from t;\n(1105, 'errCode = 2, detailMessage = errCode = 2, detailMessage = sql match regex sql block rule: rule_001')\n"})}),"\n",(0,l.jsx)(n.p,{children:"To apply multiple user-level blocking rules to a user, list all rule names separated by commas.\nTo remove all user-level blocking rules, set the rule list to an empty string."}),"\n",(0,l.jsx)(n.h4,{id:"other-operations",children:"Other Operations"}),"\n",(0,l.jsx)(n.p,{children:"Refer to the SQL Block Rule manual for instructions on modifying or deleting blocking rules."}),"\n",(0,l.jsx)(n.h3,{id:"usage-scenarios",children:"Usage Scenarios"}),"\n",(0,l.jsx)(n.p,{children:"SQL Block Rules can be used in the following scenarios:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Blocking queries that scan more than a specified number of rows"}),"\n",(0,l.jsx)(n.li,{children:"Blocking queries that scan more than a specified number of partitions"}),"\n",(0,l.jsx)(n.li,{children:"Blocking queries that scan more than a specified number of tablets"}),"\n",(0,l.jsx)(n.li,{children:"Blocking specific query patterns"}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"blocking-queries-that-scan-more-than-a-specified-number-of-rows",children:"Blocking Queries that Scan More Than a Specified Number of Rows"}),"\n",(0,l.jsx)(n.p,{children:"Scanning data significantly consumes BE's IO and CPU resources. Unnecessary full table scans can pose challenges to cluster stability. To prevent destructive queries, set a limit on the number of rows scanned per query."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'CREATE SQL_BLOCK_RULE rule_card \nPROPERTIES\n(\n   "cardinality" = "1000",\n   "global" = "true",\n   "enable" = "true"\n);\n'})}),"\n",(0,l.jsx)(n.p,{children:"With this rule, queries scanning more than 1000 rows are blocked. Note that row count calculation occurs during the planning phase, considering partition and tablet pruning but not other filtering conditions."}),"\n",(0,l.jsx)(n.h4,{id:"blocking-queries-that-scan-more-than-a-specified-number-of-partitions",children:"Blocking Queries that Scan More Than a Specified Number of Partitions"}),"\n",(0,l.jsx)(n.p,{children:"Scanning too many partitions significantly increases BE's CPU usage and may lead to network and metadata retrieval overhead, especially for external tables. To prevent this, set a limit on the number of partitions scanned per query."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'CREATE SQL_BLOCK_RULE rule_part_num \nPROPERTIES\n(\n   "partition_num" = "30",\n   "global" = "true",\n   "enable" = "true"\n);\n'})}),"\n",(0,l.jsx)(n.p,{children:"With this rule, queries scanning more than 30 partitions are blocked. Note that partition count calculation occurs during the planning phase and may not fully reflect pruning."}),"\n",(0,l.jsx)(n.h4,{id:"blocking-queries-that-scan-more-than-a-specified-number-of-tablets",children:"Blocking Queries that Scan More Than a Specified Number of Tablets"}),"\n",(0,l.jsx)(n.p,{children:"Scanning too many tablets significantly increases BE's CPU usage. To prevent this, set a limit on the number of tablets scanned per query."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'CREATE SQL_BLOCK_RULE rule_teblet_num \nPROPERTIES\n(\n   "tablet_num" = "200",\n   "global" = "true",\n   "enable" = "true"\n);\n'})}),"\n",(0,l.jsx)(n.p,{children:"With this rule, queries scanning more than 200 tablets are blocked. Note that tablet count calculation occurs during the planning phase and may not fully reflect pruning."}),"\n",(0,l.jsx)(n.h4,{id:"blocking-specific-query-patterns",children:"Blocking Specific Query Patterns"}),"\n",(0,l.jsx)(n.p,{children:"To prevent queries with high computational complexity or long planning times, you can block specific patterns using regex."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'CREATE SQL_BLOCK_RULE rule_abs\nPROPERTIES(\n  "sql"="(?i)abs\\\\s*\\\\(.+\\\\)",\n  "global"="true",\n  "enable"="true"\n);\n'})}),"\n",(0,l.jsx)(n.p,{children:"In the above regular expression:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"(?i) means case-insensitive matching."}),"\n",(0,l.jsx)(n.li,{children:"abs is the target function to be blocked."}),"\n",(0,l.jsx)(n.li,{children:"\\s* allows for any number of whitespace characters between abs and the left parenthesis."}),"\n",(0,l.jsx)(n.li,{children:"\\(.+\\) matches the function arguments. Similarly, a similar approach can be used to block set global to prevent unintended variable changes, or to block truncate table to prevent unintended data deletion."}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"faq",children:"FAQ"}),"\n",(0,l.jsx)(n.h4,{id:"q-can-regex-based-blocking-rules-have-adverse-effects-on-the-cluster",children:"Q: Can regex-based blocking rules have adverse effects on the cluster?"}),"\n",(0,l.jsx)(n.p,{children:"A: Yes. Complex regex matching is computationally intensive. Using complex regexes or too many regex-based rules can significantly increase the CPU load on the FE. Therefore, add regex-based blocking rules cautiously and avoid complex regexes unless necessary."}),"\n",(0,l.jsx)(n.h4,{id:"q-can-a-blocking-rule-be-temporarily-disabled",children:"Q: Can a blocking rule be temporarily disabled?"}),"\n",(0,l.jsx)(n.p,{children:'A: Yes. Modify the rule by setting the "enable" property to "false".'}),"\n",(0,l.jsx)(n.h4,{id:"q-what-regex-syntax-is-used-in-blocking-rules",children:"Q: What regex syntax is used in blocking rules?"}),"\n",(0,l.jsxs)(n.p,{children:["A: The regular expression of the blocking rule uses the Java regular expression specification. For common expressions, refer to the SQL syntax manual. For a complete manual, refer to: ",(0,l.jsx)(n.a,{href:"https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html",children:"https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html"})]}),"\n",(0,l.jsx)(n.h2,{id:"workload-group-policy",children:"Workload Group Policy"}),"\n",(0,l.jsx)(n.h3,{id:"note",children:"NOTE"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"The conditions and actions of the same policy must either be both FE (Frontend) or both BE (Backend). For example, set_session_variable and cancel_query cannot be configured in the same policy. Similarly, condition be_scan_rows and condition username cannot be configured in the same policy."}),"\n",(0,l.jsx)(n.li,{children:"Since the current policy is executed by asynchronous threads at fixed time intervals, there is a certain delay in the effectiveness of the policy. For example, if a user configures a policy to cancel a query when the scanned rows exceed 1 million, and the cluster resources are relatively idle at the time, it is possible that the query may have already finished before the cancellation policy takes effect. Currently, the time interval is set to 500ms, which means that queries with very short runtime may bypass the policy check."}),"\n",(0,l.jsx)(n.li,{children:"The supported load types include select/insert select/stream load/broker load/routine load."}),"\n",(0,l.jsx)(n.li,{children:"A query may match multiple policies, but only the policy with the highest priority will take effect."}),"\n",(0,l.jsx)(n.li,{children:"Currently, modification of actions and conditions is not supported; changes can only be made by deleting and recreating the policy."}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"supported-workload-load",children:"Supported Workload Load"}),"\n",(0,l.jsx)(n.p,{children:"Starting from Doris 2.1, large query circuit-breaking can be implemented through Workload Policy."}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"version"}),(0,l.jsx)(n.th,{children:"2.1"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"select"}),(0,l.jsx)(n.td,{children:"\u221A"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"insert into select"}),(0,l.jsx)(n.td,{children:"\u221A"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"insert into values"}),(0,l.jsx)(n.td,{children:"X"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"stream load"}),(0,l.jsx)(n.td,{children:"\u221A"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"routine load"}),(0,l.jsx)(n.td,{children:"\u221A"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"backup"}),(0,l.jsx)(n.td,{children:"X"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"compaction"}),(0,l.jsx)(n.td,{children:"X"})]})]})]}),"\n",(0,l.jsx)(n.h3,{id:"create-workload-policy",children:"Create Workload Policy"}),"\n",(0,l.jsx)(n.p,{children:"The CREATE WORKLOAD POLICY command can be used to create a resource management policy.\nIn the example below, a policy named test_cancel_policy is created, which will cancel any queries running for more than 1000ms in the cluster. The policy is currently enabled. Creating a Workload Policy requires admin_priv privileges."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"create workload policy test_cancel_policy\nconditions(query_time > 1000)\nactions(cancel_query) \nproperties('enabled'='true'); \n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5728\u521B\u5EFA Workload Policy \u65F6\u9700\u8981\u6307\u5B9A\u4EE5\u4E0B\u5185\u5BB9\uFF1A"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:'conditions: Represents the trigger conditions for the policy. Multiple conditions can be chained together, separated by commas (,), indicating an "AND" relationship. In the example above, query_time > 1000 means the policy will be triggered when the query time exceeds 1 second.'}),"\n",(0,l.jsx)(n.li,{children:"action: Specifies the action to be taken when the condition is triggered. Currently, a policy can define only one action (except for set_session_variable). In the example above, cancel_query indicates that the query should be canceled."}),"\n",(0,l.jsx)(n.li,{children:"properties\uFF0C Defines the attributes of the policy, including whether it is enabled and its priority."}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"A policy can only be applied to either the FE (Frontend) or BE (Backend) component, not both simultaneously. This is because FE and BE have independent conditions and actions, and the policy does not distinguish between FE and BE components. The following table lists the clause options for the policy:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Components"}),(0,l.jsx)(n.th,{children:"condition&action"}),(0,l.jsx)(n.th,{children:"metric"}),(0,l.jsx)(n.th,{children:"explain"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"FE"}),(0,l.jsx)(n.td,{children:"conditions"}),(0,l.jsx)(n.td,{children:"username"}),(0,l.jsx)(n.td,{children:"When a queried username is a certain value, the corresponding action will be triggered."})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{children:"actions"}),(0,l.jsx)(n.td,{children:"set_session_variable"}),(0,l.jsxs)(n.td,{children:["This action can execute a statement that sets session variable. The same policy can have multiple ",(0,l.jsx)(n.code,{children:"set_session_variable"}),", which means that a policy can execute multiple statements that modify the session variable."]})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"BE"}),(0,l.jsx)(n.td,{children:"conditions"}),(0,l.jsx)(n.td,{children:"be_scan_rows"}),(0,l.jsx)(n.td,{children:"The number of rows scanned by an SQL within a single BE process, if the SQL is executed concurrently on the BE, it is the cumulative value of multiple concurrency."})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{children:"be_scan_bytes"}),(0,l.jsx)(n.td,{children:"The number of bytes scanned by an SQL within a single BE process, if the SQL is executed concurrently on the BE, it is the cumulative value of multiple concurrency, measured in bytes."})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{children:"query_time"}),(0,l.jsx)(n.td,{children:"The running time of an SQL on a single BE process, measured in milliseconds."})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{children:"query_be_memory_bytes"}),(0,l.jsx)(n.td,{children:"The memory used by an SQL within a BE process, if the SQL is executed concurrently on the BE, it is the cumulative value of multiple concurrency, measured in bytes."})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{children:"actions"}),(0,l.jsx)(n.td,{children:"cancel_query"}),(0,l.jsx)(n.td,{children:"cancel query."})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"FE&BE"}),(0,l.jsx)(n.td,{children:"properties"}),(0,l.jsx)(n.td,{children:"enabled"}),(0,l.jsx)(n.td,{children:"the value is either true or false. The default value is true, indicating that the current policy is enabled, while false indicates that the current policy is disabled."})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{children:"priority"}),(0,l.jsx)(n.td,{children:"the value range is a positive integer from 0 to 100, with a default value of 0. The higher the value, the higher the priority of the policy. The main function of this attribute is to select the policy with the highest priority when multiple policies are matched."})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{}),(0,l.jsx)(n.td,{children:"workload_group"}),(0,l.jsx)(n.td,{children:"A policy can be bound to a workload group, indicating that this policy only applies to a certain workload group.The default value is empty, which means it will take effect for all queries."})]})]})]}),"\n",(0,l.jsx)(n.h3,{id:"binding-workload-policy-to-workload-group",children:"Binding Workload Policy to Workload Group"}),"\n",(0,l.jsx)(n.p,{children:"By default, the Workload Policy applies to all supported queries. If you want the policy to apply only to a specific Workload Group, you need to bind the policy to the Workload Group using the workload_group option. The statement is as follows:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"create workload policy test_cancel_big_query\nconditions(query_time > 1000)\nactions(cancel_query) \nproperties('workload_group'='normal')\n"})}),"\n",(0,l.jsx)(n.h2,{id:"test",children:"Test"}),"\n",(0,l.jsx)(n.h3,{id:"1-set-session-variables",children:"1 set session variables"}),"\n",(0,l.jsx)(n.p,{children:"Attempt to modify concurrency related parameters in the session variable of the admin user."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"// show variable parallel_fragment_exec_instance_num of admin user.\nmysql [(none)]>show variables like '%parallel_fragment_exec_instance_num%';\n+-------------------------------------+-------+---------------+---------+\n| Variable_name                       | Value | Default_Value | Changed |\n+-------------------------------------+-------+---------------+---------+\n| parallel_fragment_exec_instance_num | 8     | 8             | 0       |\n+-------------------------------------+-------+---------------+---------+\n1 row in set (0.00 sec)\n\n\n// create a policy which reset session variable.\ncreate workload policy test_set_var_policy\nconditions(username='admin')\nactions(set_session_variable 'parallel_fragment_exec_instance_num=1') \n\n\n// After a while, check the session variable of the admin.\nmysql [(none)]>show variables like '%parallel_fragment_exec_instance_num%';\n+-------------------------------------+-------+---------------+---------+\n| Variable_name                       | Value | Default_Value | Changed |\n+-------------------------------------+-------+---------------+---------+\n| parallel_fragment_exec_instance_num | 1     | 8             | 1       |\n+-------------------------------------+-------+---------------+---------+\n1 row in set (0.01 sec)\n"})}),"\n",(0,l.jsx)(n.h3,{id:"2-big-query-fusing-test",children:"2 big query fusing test"}),"\n",(0,l.jsx)(n.p,{children:"Test fusing queries that have run for more than 3 seconds. The following is the audit log of a successful execution of q29 in Clickbench. It can be seen that it takes 4.5 seconds for this SQL to run."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"mysql [hits]>SELECT REGEXP_REPLACE(Referer, '^https?://(?:www\\.)?([^/]+)/.*$', '\\1') AS k, AVG(length(Referer)) AS l, COUNT(*) AS c, MIN(Referer) FROM hits WHERE Referer <> '' GROUP BY k HAVING COUNT(*) > 100000 ORDER BY l DESC LIMIT 25;\n+-----------------------------------------------------------------------+------------------+----------+---------------------------------------------------------------------------------------------------------------------+\n| k                                                                     | l                | c        | min(Referer)                                                                                                        |\n+-----------------------------------------------------------------------+------------------+----------+---------------------------------------------------------------------------------------------------------------------+\n| 1                                                                     | 85.4611926713085 | 67259319 | http://%26ad%3D1%25EA%25D0%26utm_source=web&cd=19590&input_onlist/\u0431\u0438-2 \u043C\u0435\u0441\u0442\u043E \u0431\u0443\u0434\u0443\u0449\u0435\u0439 \u043A\u043E\u043D\u0434\u0438\u0446\u0438\u043D                       |\n| http:%2F%2Fwwww.regnancies/search&evL8gE&where=all&filmId=bEmYZc_WTDE |               69 |   207347 | http:%2F%2Fwwww.regnancies/search&evL8gE&where=all&filmId=bEmYZc_WTDE                                               |\n| http://\u043D\u043E\u0432\u043E\u0441\u0442\u0440\u0430\u0448\u043D\u0430\u044F                                                   |               31 |   740277 | http://\u043D\u043E\u0432\u043E\u0441\u0442\u0440\u0430\u0448\u043D\u0430\u044F                                                                                                 |\n| http://loveche.html?ctid                                              |               24 |   144901 | http://loveche.html?ctid                                                                                            |\n| http://rukodeliveresult                                               |               23 |   226135 | http://rukodeliveresult                                                                                             |\n| http://holodilnik.ru                                                  |               20 |   133893 | http://holodilnik.ru                                                                                                |\n| http://smeshariki.ru                                                  |               20 |   210736 | http://smeshariki.ru                                                                                                |\n| http:%2F%2Fviewtopic                                                  |               20 |   391115 | http:%2F%2Fviewtopic                                                                                                |\n| http:%2F%2Fwwww.ukr                                                   |               19 |   655178 | http:%2F%2Fwwww.ukr                                                                                                 |\n| http:%2F%2FviewType                                                   |               19 |   148907 | http:%2F%2FviewType                                                                                                 |\n| http://state=2008                                                     |               17 |   139630 | http://state=2008                                                                                                   |\n+-----------------------------------------------------------------------+------------------+----------+---------------------------------------------------------------------------------------------------------------------+\n11 rows in set (4.50 sec)\n"})}),"\n",(0,l.jsx)(n.p,{children:"Create a policy that cancels queries after running for more than 3 seconds"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"create workload policy test_cancel_3s_query\nconditions(query_time > 3000)\nactions(cancel_query) \n"})}),"\n",(0,l.jsx)(n.p,{children:"Executing SQL again will result in a direct error message."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"mysql [hits]>SELECT REGEXP_REPLACE(Referer, '^https?://(?:www\\.)?([^/]+)/.*$', '\\1') AS k, AVG(length(Referer)) AS l, COUNT(*) AS c, MIN(Referer) FROM hits WHERE Referer <> '' GROUP BY k HAVING COUNT(*) > 100000 ORDER BY l DESC LIMIT 25;\nERROR 1105 (HY000): errCode = 2, detailMessage = (10.16.10.8)[CANCELLED]query canceled by workload policy,id:12345\n"})})]})}function h(e={}){let{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},250065:function(e,n,i){i.d(n,{Z:function(){return a},a:function(){return s}});var t=i(667294);let l={},r=t.createContext(l);function s(e){let n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);